#!/bin/bash
# Extract subtitles from each MKV file in the given directory, requires mkvtoolnix, sed

# If no directory is given, work in local dir
if [ "$1" = "" ]; then
  DIR="."
else
  DIR="$1"
fi

echo $DIR
# Get all the MKV files in this dir and its subdirs
find "$DIR" -type f -name '*.mkv' | while read filename
do
	if [ ! -f "${filename%.*}.srt" ]; then
	  # Find out which tracks contain the subtitles
	  mkvmerge -i "$filename" | grep 'subtitles' | while read subline
	  do
		# Grep the number of the subtitle track
		tracknumber=`echo $subline | egrep -o "[0-9]{1,2}" | head -1`

		# Extract the track to a .tmp file
		echo "Processing: $filename"
		mkvextract tracks "$filename" "$tracknumber":"${filename%.*}.tmp" &> /dev/null
		
		#echo $subline
		if [[ $subline == *"S_TEXT/ASS"* ]]
		then
		  echo "Found ASS substile, converting:"
	          mv "${filename%.*}.tmp"  "${filename%.*}.ass" 

		  #Strips ass tags: http://docs.aegisub.org/3.2/ASS_Tags/
		  sed -i 's/{[^{}]*}//g' "${filename%.*}.ass"
		  sed -i 's/\\n/ /g' "${filename%.*}.ass"
		  sed -i 's/\\N/ /g' "${filename%.*}.ass"
		  sed -i 's/\\H/ /g' "${filename%.*}.ass"
                  
		  #Converts video
		  #avconv -i "${filename%.*}.ass" -y -scodec srt "${filename%.*}.srt" 
		  $DIR/ass2srt.pl "${filename%.*}.ass" "${filename%.*}.srt" &> /dev/null
		  
		  #Strips html tags generated by ffmpeg
		  sed -i 's/<[^>]*>//g' "${filename%.*}.srt"
		  echo "Done. Deleting tmp files"
		  rm "${filename%.*}.ass" &> /dev/null
		  rm "${filename%.*}.tmp" &> /dev/null

		fi

	  done
	fi  
done
